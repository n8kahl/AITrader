
# Options Copilot (Starter Repo)

**Upload a broker screenshot → parse a structured position → validate with Polygon → compute context (ATR/VWAP/EM/GEX) → get a management plan (stops/targets/hedges).**
Includes **extended modules**: Live WebSocket Aggregator (stocks/options), **Gamma Engine**, and **LEAP recommender**.

> ⚠️ **Compliance**: This is for educational use. Ship *advice-only* by default. Require explicit user confirmation for any execution. Add daily loss limits, spread% caps, journaling, and appropriate registrations for live trading.

## Stack
- **OpenAI Agents SDK (Agent Kit)**: multi-agent logic (Quant / Coach / Risk / Trader), tools & handoffs.
- **OpenAI Structured Outputs + Vision**: parse screenshot → **Position JSON**.
- **OpenAI Realtime (WebRTC)**: voice coaching (speak at inflection points).
- **Polygon.io**: stocks aggregates, options quotes/trades, **Option Chain Snapshot** (greeks/IV/OI).
- **Railway**: one-click deploy from GitHub.

## Quickstart
```bash
cd apps/gateway
cp .env.example .env                  # fill OPENAI_API_KEY + Polygon key
# Use either POLYGON_KEY or POLYGON_API_KEY in .env
npm i
npm run build
npm start
# open http://localhost:8080, upload a screenshot, see the plan JSON
```

## Core Endpoint
- `POST /api/manage-from-image`  
  **Body**: `{ "imageUrl": "<dataURL or https://...>", "hints": "optional", "mode": "advice" | "execute" }`  
  **Returns**: `{ position, validated, context, plan }`

## Fast Plan Endpoint (no OpenAI key required)
- `POST /api/fast-plan-from-json`
  **Body**: `{ "position": { "underlying":"AAPL","expiration":"2026-01-16","strike":250,"right":"C","quantity":1,"avg_price":1.23 } }`
  **Returns**: `{ position, validated, context, plan, fast:true }`
  Notes: Plan is generated by deterministic rules (ATR/EM/VWAP). Use `/api/manage-from-json` with `OPENAI_API_KEY` for LLM plans.

## Watchlist & Real-time Monitoring
- Add/remove symbols to the internal watchlist:
  - `POST /api/watch` → `{ symbol:"SPY", horizon:"scalp" }`
  - `GET /api/watch`
  - `DELETE /api/watch/SPY`
- Subscribe to lightweight event stream (quotes, watch updates, signal snapshots):
  - `GET /api/events` (Server-Sent Events)
- Snapshots contain price, VWAP/EMA/ATR/RVOL levels, gamma, and a confluence score. Data stays in your gateway; the model receives only compact JSON when you call `/api/manage-from-json` or `/api/fast-plan-from-json`.

### Signals & Orders
- The gateway computes a confluence-based signal state machine (forming → confirmed → invalidated) and emits `signal.update` events on `/api/events`.
- Paper order flow:
  1. `POST /api/orders/preview` with `{ intent: { symbol, side, qty, type, limit? } }`
  2. Check guards (`spread_ok`, `liquidity_ok`, `max_positions`, `daily_limit`).
  3. `POST /api/orders/place` with `{ intent: {...}, confirm: true }` to execute when you are satisfied.
- Order events appear on SSE (`order.update`) and are journaled in Postgres if `DATABASE_URL` is set.

## Security
- Optional bearer token: set `API_BEARER_TOKEN` to require `Authorization: Bearer <token>` on all `/api/*` routes.
- The gateway serves an OpenAPI spec at `/openapi.yaml` so you can wire tools in code (OpenAI Agents SDK) without the Agent Builder UI.

## Extended Modules
- **Live WebSocket Aggregator** (`src/services/live.ts`): connect to Polygon Stocks & Options sockets; in-memory bar/quote cache; EventEmitter hooks.
- **Gamma Engine** (`src/services/gamma.ts`): computes net GEX from Option Chain Snapshot; used in `context.ts`.
- **LEAP Recommender** (`src/tools/leaps.ts`): screens for Δ≈0.6, DTE 200–550, low IV context, trend slope (EMA 21>50).

## Deploy on Railway
- Connect your GitHub repo; set env vars in Railway UI.
- (Optional) Use the GitHub Action in `infra/github-actions/railway-deploy.yml`.

## Safety
- Advice-only default; execution requires explicit "Yes, execute".
- Spread% guard, daily R cap, journaling & audit trail (extend `journal.ts` and add DB).
